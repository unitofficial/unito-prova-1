<!DOCTYPE html>
<html lang="it">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      /* Stile per il pulsante personalizzato */
      #capture {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 80px;
        background: #FD0BF8;
        background-image: url('foto-unito.png'); /* Immagine allegata */
        background-size: cover;
        background-position: center;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        z-index: 1000;
      }

      /* Effetto pressione */
      #capture:active {
        transform: translateX(-50%) scale(0.9);
      }

      /* Messaggio di registrazione attiva */
      #recordingIndicator {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 10px;
        font-size: 16px;
        border-radius: 10px;
        display: none;
        z-index: 1001;
      }
    </style>
  </head>
  <body>
    <a-scene 
      mindar-image="imageTargetSrc: marker.mind; stabilizationThreshold: 0.02;" 
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <a-asset-item id="avatarModel" src="modello.glb"></a-asset-item>
      </a-assets>

      <a-light type="ambient" intensity="1"></a-light>
      <a-camera id="camera" position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Collegamento del modello 3D a tutti i 12 marker -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 1">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 2">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 3">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 4">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 5">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 6">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 7">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 8">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 9">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 10">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 11">
        <a-gltf-model src="#avatarModel" position="0 0.4 0.1" scale="0.01 0.01 0.01" rotation="0 180 0"></a-gltf-model>
      </a-entity>
    </a-scene>

    <div id="recordingIndicator">Registrazione in corso...</div>
    <button id="capture"></button>

    <script>
      const captureButton = document.getElementById('capture');
      const recordingIndicator = document.getElementById('recordingIndicator');
      const scene = document.querySelector('a-scene');
      let mediaRecorder;
      let recordedChunks = [];
      let isRecording = false;

      function takeScreenshot() {
        const canvas = document.createElement("canvas");
        const renderer = scene.renderer;
        const video = document.querySelector("video");

        canvas.width = renderer.domElement.width;
        canvas.height = renderer.domElement.height;
        const ctx = canvas.getContext("2d");

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.download = "screenshot.png";
        link.href = imageData;
        link.click();
      }

      function startRecording() {
        recordedChunks = [];
        const stream = scene.renderer.domElement.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'video.mp4';
          a.click();
        };

        mediaRecorder.start();
        isRecording = true;
        recordingIndicator.style.display = 'block';
      }

      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          isRecording = false;
          recordingIndicator.style.display = 'none';
        }
      }

      let pressTimer;
      captureButton.addEventListener('pointerdown', (event) => {
        event.preventDefault();
        pressTimer = setTimeout(() => {
          startRecording();
        }, 500);
      });

      captureButton.addEventListener('pointerup', (event) => {
        event.preventDefault();
        clearTimeout(pressTimer);
        if (!isRecording) {
          takeScreenshot();
        } else {
          stopRecording();
        }
      });

      captureButton.addEventListener('pointerleave', (event) => {
        event.preventDefault();
        clearTimeout(pressTimer);
        if (isRecording) {
          stopRecording();
        }
      });
    </script>
  </body>
</html>